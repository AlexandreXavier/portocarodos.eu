machine:
  environment:
    HUGO_VERSION: 0.20.7
    CIRCLE_BUILD_DIR: $HOME/$CIRCLE_PROJECT_REPONAME
    PATH: $PATH:$CIRCLE_BUILD_DIR/bin
  post:
    - mkdir -p $CIRCLE_BUILD_DIR/bin
dependencies:
  cache_directories:
    - bin
  pre:
    # Hugo, Pygments and s3deploy dependencies
    - >
      if [ ! -e $CIRCLE_BUILD_DIR/bin/hugo ] || [[ `hugo version` =~ v${HUGO_VERSION} ]]; then
        wget https://github.com/spf13/hugo/releases/download/v${HUGO_VERSION}/hugo_${HUGO_VERSION}_Linux-64bit.tar.gz;
        tar xvzf hugo_${HUGO_VERSION}_Linux-64bit.tar.gz -C $CIRCLE_BUILD_DIR/bin;
      fi

    - pip install Pygments
    - go get -v github.com/bep/s3deploy

# overload the `test` step to build the static assets
test:
  pre:
    - pygmentize -V
  override:
    - hugo -v
    - ls -l public

deployment:
  s3up:
    branch: master
    commands:
      # updates: http://mostlygeek.com.s3-website-us-east-1.amazonaws.com
      - ls -lR public/
      - s3deploy -source=public/ -region=us-east-1 -bucket=mostlygeek.com
